---
title: "Indicator - NameOfIndicator"
output:
  pdf_document:
    toc: true
    toc_depth: 3
    
knit: (function(input_file, encoding) {
  out_dir <- 'pdfOutput';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'naturindeksViken.pdf'))})
---


```{r setup, include=FALSE, message=FALSE}
library(knitr)
library(tmap)
knitr::opts_chunk$set(echo = TRUE)
```

# Description
*Add a description about the metric/indicator and fill in the table below*.


ECT-klasse | Geographic extent | Ecosystem   | Time series | Last year
---------- | -------------     | ----------  | ------------| ----------
B2 |  Norway       | Forest | Yes      | 2019


Characteristic |
---------------|
*Describe the characteristic here*|
 

You can use the headers suggeted below, and costumise as needed.

# Data prepartion

Personal user name and pasword
```{r}
myUser <- "anders.kolstad@nina.no"
 # hemmelig passord
myPwd  <- ""
```

Import dataset from the Naturindeks database
```{r, eval = F}
skog <- NIcalc::importDatasetApi(
  username = myUser,
  password = myPwd,
  eco = "Skog", 
  indic = NULL,
  year = c("1990","2000","2010","2014","2019"))

#saveRDS(skog, "P:/41001581_egenutvikling_anders_kolstad/data/tilstandsindikatorer/naturindeksSkog.rds")
#saveRDS(skog, "/data/P-Prosjekter/41001581_egenutvikling_anders_kolstad/data/tilstandsindikatorer/naturindeksSkog.rds")


rm(skog)
rm(myPwd)
```

Load data back from the server
```{r}
#fjelldat <- readRDS("/data/P-Prosjekter/41201042_okologisk_tilstand_fastlandsnorge_2020_dataanaly/fjell2021/data/naturindeks/NIfjell-1990-2019.rds")

skog <- readRDS("/data/Egenutvikling/41001581_egenutvikling_anders_kolstad/data/tilstandsindikatorer/naturindeksSkog.rds")
```

List the 89 indikcators
```{r}
(inds <- skog$indicators$name)
```

Assemble dataset *(runtime approx. )*
```{r, eval =F}

#skog2 <- c(skog, NIunits = list(skog$BSunits))
#skog2$NIunits$BSunitId <- skog2$NIunits$id

A <- NIcalc::assembleNiObject(
  inputData = skog,
  predefNIunits = c(allArea = T, parts = F, counties = F),
  partOfTotal = 0.01, 
  indexType = "ecosystem",
  part = "ecosystem",
  total = "terrestrial")

saveRDS(A, "/data/Egenutvikling/41001581_egenutvikling_anders_kolstad/data/tilstandsindikatorer/naturindeksSkog_assembled.rds")
```

```{r}
A <- readRDS("/data/Egenutvikling/41001581_egenutvikling_anders_kolstad/data/tilstandsindikatorer/naturindeksSkog_assembled.rds")
```

Looking for missing values
```{r, eval=F}
D <- NIcalc::imputeDiagnostics(x = A,
  nSim = 10,
  transConst = 0.01,
  maxit = 20)
```


```{r, eval=F}
D$diagnostics$mdDistribuiton
```

It looks quite good from the year 2000. 
Imputing data:

```{r, eval=F}
I <- NIcalc::imputeData(x = A,
    nSim = 100,   # default is 1000
    transConst = 0.01,
    maxit = 20,
    printFlag = TRUE)

saveRDS(I, "P:/41001581_egenutvikling_anders_kolstad/data/tilstandsindikatorer/naturindeksSkog_imputed.rds")
```

```{r, eval=F}
I <- readRDS("/data/Egenutvikling//41001581_egenutvikling_anders_kolstad/data/tilstandsindikatorer/naturindeksSkog_imputed.rds")
```

```{r, eval=F}
I2 <- NIcalc::impStand(x = A,
             imputations = I)
```



Calculate index values (ignorin imputed values for now)

```{r, eval=F}
NI <- NIcalc::calculateIndex(
  x       = A,
  #imputations = I2,
  nsim     = 10000,
  awBSunit = "Skog",
  fids     = F,    # should fidelities be ignored in 
                   # the calculation of Wi?
  tgroups  = F, # should grouping of indicators 
                   # into trophic and key indicator 
                   # groups be ignored
  keys     = "ignore",
  awbs=F # arealvekting basert på fjellareal i hver kommune
)

saveRDS(NI, "/data/Egenutvikling/41001581_egenutvikling_anders_kolstad/data/tilstandsindikatorer/naturindeksSkog_index.rds")
```

```{r}
NI <- readRDS("/data/Egenutvikling/41001581_egenutvikling_anders_kolstad/data/tilstandsindikatorer/naturindeksSkog_index.rds")
```

Get the BSunitIDs from the NI dataframe. These are 'kommunenummer'
```{r}
BSunits <- NI$wholeArea$`1990`$BSunitData$id
df <- data.frame(kommuneID = BSunits)
```


Here are the version of the municipality map from Norway. M3 is from 2010.
```{r}
M <- sf::st_read("/data/R/GeoSpatialData/AdministrativeUnits/Norway_AdministrativeUnits/Converted/Norway_Municipalities/Kommune_polygon_2022_navn.shp")
M2 <- sf::st_read("/data/R/GeoSpatialData/AdministrativeUnits/Norway_AdministrativeUnits/Converted/Norway_Municipalities/versjon_2018/Kommuner_2018.shp")
M3 <- sf::st_read("/data/Egenutvikling/41001581_egenutvikling_anders_kolstad/data/tilstandsindikatorer/kommuner2010/Norway_ABAS_utm33n.shp")
```

```{r}
df$kommuneID %in% M$kommunenum
df$kommuneID %in% M2$KOMMUNENUM
df$kommuneID[17]
df$kommuneID %in% M3$KommNR # YES
```

Putting the index values and the standard deviations into the correct shape file
```{r}

df$v_1990 <- rowMeans(NI$wholeArea$`1990`$BSunitIndices)
df$v_2000 <- rowMeans(NI$wholeArea$`2000`$BSunitIndices)
df$v_2010 <- rowMeans(NI$wholeArea$`2010`$BSunitIndices)
df$v_2014 <- rowMeans(NI$wholeArea$`2014`$BSunitIndices)
df$v_2019 <- rowMeans(NI$wholeArea$`2019`$BSunitIndices)

df$sd_1990 <- matrixStats::rowSds(NI$wholeArea$`1990`$BSunitIndices)
df$sd_2000 <- matrixStats::rowSds(NI$wholeArea$`2000`$BSunitIndices)
df$sd_2010 <- matrixStats::rowSds(NI$wholeArea$`2010`$BSunitIndices)
df$sd_2014 <- matrixStats::rowSds(NI$wholeArea$`2014`$BSunitIndices)
df$sd_2019 <- matrixStats::rowSds(NI$wholeArea$`2019`$BSunitIndices)

M3$v_1990 <- df$v_1990[match(M3$KommNR, df$kommuneID)]
M3$v_2000 <- df$v_2000[match(M3$KommNR, df$kommuneID)]
M3$v_2010 <- df$v_2010[match(M3$KommNR, df$kommuneID)]
M3$v_2014 <- df$v_2014[match(M3$KommNR, df$kommuneID)]
M3$v_2019 <- df$v_2019[match(M3$KommNR, df$kommuneID)]

M3$sd_1990 <- df$sd_1990[match(M3$KommNR, df$kommuneID)]
M3$sd_2000 <- df$sd_2000[match(M3$KommNR, df$kommuneID)]
M3$sd_2010 <- df$sd_2010[match(M3$KommNR, df$kommuneID)]
M3$sd_2014 <- df$sd_2014[match(M3$KommNR, df$kommuneID)]
M3$sd_2019 <- df$sd_2019[match(M3$KommNR, df$kommuneID)]



```



```{r}
tm_shape(M3)+
  tm_polygons(col = 'v_1990',
              alpha=0.5)
```


```{r, eval=F}
NIunits <- names(NI)
myYears <- c("1990","2000","2010","2014","2019")

IND_samp <- data.frame(reg  = rep(NIunits, each=length(myYears)*10000),
                       year = rep(myYears, each=10000, times= length(NIunits)),
                       val  = NA)

for(i in 1:length(NIunits)){
  for(n in 1:length(myYears)){
    #print(i)
    #print(n)
    temp <- fjellIndex2[[i]][[n]]$index
    IND_samp$val[IND_samp$reg == NIunits[i] &
                    IND_samp$year == myYears[n]] <- temp
    
  }
  
}
```


```{r, eval=F}
NI$N$`1990`$BSunitIndices[1,1]
```

There are 10000 estimates per BSunit. Here are the first 3 for Bodø
```{r, eval=F}
NI$N$`1990`$BSunitIndices[1,1:3]
```



# Reference values

# Map values to polygons


# Export
Export the maps with the variables to `data/variables/MyFile`. You should not rasterize shape files at this stage. If the data is in the shape format, you should export it using `sf::st_write()` with one column names `value`, and one column names `reference`. If you have a time series, you need one file per year and the year should come at the end of the file name (all else remaining the same).  If you have a raster, add the vallues to band 1, and the referece value to band 2.   
```{r, eval=F}
#sf::st_write(..., "../../data/variables/....shp")
```

